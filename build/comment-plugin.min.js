/*!
* rete-comment-plugin v0.6.1 
* (c) 2020 Vitaliy Stoliarov 
* Released under the MIT license.
*/
!function(t){"use strict";var c,e=Object.prototype,s=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",r=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag",a="object"==typeof module,u=t.regeneratorRuntime;if(u)a&&(module.exports=u);else{(u=t.regeneratorRuntime=a?module.exports:{}).wrap=w;var f="suspendedStart",h="suspendedYield",d="executing",m="completed",p={},l={};l[o]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(N([])));y&&y!==e&&s.call(y,o)&&(l=y);var g=O.prototype=k.prototype=Object.create(l);x.prototype=g.constructor=O,O.constructor=x,O[i]=x.displayName="GeneratorFunction",u.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===x||"GeneratorFunction"===(e.displayName||e.name))},u.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,O):(t.__proto__=O,i in t||(t[i]="GeneratorFunction")),t.prototype=Object.create(g),t},u.awrap=function(t){return{__await:t}},E(C.prototype),C.prototype[r]=function(){return this},u.AsyncIterator=C,u.async=function(t,e,n,r){var o=new C(w(t,e,n,r));return u.isGeneratorFunction(e)?o:o.next().then(function(t){return t.done?t.value:o.next()})},E(g),g[i]="Generator",g[o]=function(){return this},g.toString=function(){return"[object Generator]"},u.keys=function(n){var r=[];for(var t in n)r.push(t);return r.reverse(),function t(){for(;r.length;){var e=r.pop();if(e in n)return t.value=e,t.done=!1,t}return t.done=!0,t}},u.values=N,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=c,this.done=!1,this.delegate=null,this.method="next",this.arg=c,this.tryEntries.forEach(j),!t)for(var e in this)"t"===e.charAt(0)&&s.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=c)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var r=this;function t(t,e){return i.type="throw",i.arg=n,r.next=t,e&&(r.method="next",r.arg=c),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var o=this.tryEntries[e],i=o.completion;if("root"===o.tryLoc)return t("end");if(o.tryLoc<=this.prev){var a=s.call(o,"catchLoc"),u=s.call(o,"finallyLoc");if(a&&u){if(this.prev<o.catchLoc)return t(o.catchLoc,!0);if(this.prev<o.finallyLoc)return t(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return t(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return t(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&s.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=t,i.arg=e,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),j(n),p}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;j(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:N(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=c),p}}}function w(t,e,n,r){var i,a,u,c,o=e&&e.prototype instanceof k?e:k,s=Object.create(o.prototype),l=new P(r||[]);return s._invoke=(i=t,a=n,u=l,c=f,function(t,e){if(c===d)throw new Error("Generator is already running");if(c===m){if("throw"===t)throw e;return _()}for(u.method=t,u.arg=e;;){var n=u.delegate;if(n){var r=L(n,u);if(r){if(r===p)continue;return r}}if("next"===u.method)u.sent=u._sent=u.arg;else if("throw"===u.method){if(c===f)throw c=m,u.arg;u.dispatchException(u.arg)}else"return"===u.method&&u.abrupt("return",u.arg);c=d;var o=b(i,a,u);if("normal"===o.type){if(c=u.done?m:h,o.arg===p)continue;return{value:o.arg,done:u.done}}"throw"===o.type&&(c=m,u.method="throw",u.arg=o.arg)}}),s}function b(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}function k(){}function x(){}function O(){}function E(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function C(c){var e;this._invoke=function(n,r){function t(){return new Promise(function(t,e){!function e(t,n,r,o){var i=b(c[t],c,n);if("throw"!==i.type){var a=i.arg,u=a.value;return u&&"object"==typeof u&&s.call(u,"__await")?Promise.resolve(u.__await).then(function(t){e("next",t,r,o)},function(t){e("throw",t,r,o)}):Promise.resolve(u).then(function(t){a.value=t,r(a)},o)}o(i.arg)}(n,r,t,e)})}return e=e?e.then(t,t):t()}}function L(t,e){var n=t.iterator[e.method];if(n===c){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=c,L(t,e),"throw"===e.method))return p;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var r=b(n,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,p;var o=r.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=c),e.delegate=null,p):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,p)}function S(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(S,this),this.reset(!0)}function N(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(s.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=c,t.done=!0,t};return r.next=r}}return{next:_}}function _(){return{value:c,done:!0}}}(function(){return this}()||Function("return this")()),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.CommentPlugin={})}(this,function(t){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function e(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function n(o){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},e=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),e.forEach(function(t){var e,n,r;e=o,r=i[n=t],n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r})}return o}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function c(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function s(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?c(t):e}function l(t,e,n){return(l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=a(t)););return t}(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(n):o.value}})(t,e,n||t)}function f(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function m(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}!function(t){if(t&&"undefined"!=typeof window){var e=document.createElement("style");e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e)}}(".inline-comment, .frame-comment {\n  color: black;\n  padding: 12px;\n  font-size: 140%;\n  position: absolute;\n  cursor: move;\n  border-radius: 16px; }\n  .inline-comment:focus, .frame-comment:focus {\n    outline: none;\n    border-color: #ffd92c; }\n\n.inline-comment {\n  z-index: 4;\n  background: #aec4ff;\n  border: 3px solid #aec4ff; }\n\n.frame-comment {\n  z-index: -10;\n  background: rgba(15, 80, 255, 0.2);\n  border: 6px solid transparent; }\n");var h=function(){function o(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){},r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:function(){};i(this,o),this.mouseStart=null,this.el=t,this.onStart=e,this.onTranslate=n,this.onDrag=r,this.initEvents(t)}return e(o,[{key:"initEvents",value:function(t){t.addEventListener("pointerdown",this.down.bind(this)),window.addEventListener("pointermove",this.move.bind(this)),window.addEventListener("pointerup",this.up.bind(this))}},{key:"getCoords",value:function(t){var e=t.touches?t.touches[0]:t;return[e.pageX,e.pageY]}},{key:"down",value:function(t){t.stopPropagation(),this.mouseStart=this.getCoords(t),this.onStart()}},{key:"move",value:function(t){if(this.mouseStart){t.preventDefault(),t.stopPropagation();var e=f(this.getCoords(t),2),n=e[0],r=e[1],o=[n-this.mouseStart[0],r-this.mouseStart[1]],i=this.el.getBoundingClientRect().width/this.el.offsetWidth;this.onTranslate(o[0]/i,o[1]/i)}}},{key:"up",value:function(){this.mouseStart&&this.onDrag(),this.mouseStart=null}}]),o}(),d=function(){function n(t,e){i(this,n),this.editor=e,this.text=t,this.scale=1,this.x=0,this.y=0,this.dragPosition=[0,0],this.links=[],this.initView(),this.update()}return e(n,[{key:"initView",value:function(){var n=this;this.el=document.createElement("div"),this.el.tabIndex=1,this.el.addEventListener("contextmenu",this.onContextMenu.bind(this)),this.el.addEventListener("focus",this.onFocus.bind(this)),this.el.addEventListener("blur",this.onBlur.bind(this)),this.el.title=this.text,new h(this.el,function(){return n.onStart()},function(t,e){return n.onTranslate(t,e)})}},{key:"linkTo",value:function(t){this.links=t||[]}},{key:"linkedTo",value:function(t){return this.links.includes(t.id)}},{key:"k",value:function(){return 1}},{key:"onContextMenu",value:function(t){t.preventDefault(),t.stopPropagation(),this.editor.trigger("editcomment",this)}},{key:"onFocus",value:function(){this.scale=Math.max(1,1/this.k()),this.update(),this.editor.trigger("commentselected",this)}},{key:"focused",value:function(){return document.activeElement===this.el}},{key:"onBlur",value:function(){this.scale=1,this.update()}},{key:"blur",value:function(){this.el.blur()}},{key:"onStart",value:function(){this.dragPosition=[this.x,this.y]}},{key:"onTranslate",value:function(t,e){var n=f(this.dragPosition,2),r=n[0],o=n[1];this.x=r+this.scale*t,this.y=o+this.scale*e,this.update()}},{key:"update",value:function(){this.el.innerText=this.text,this.el.style.transform="translate(".concat(this.x,"px, ").concat(this.y,"px) scale(").concat(this.scale,")"),this.el.title=this.text}},{key:"toJSON",value:function(){return{text:this.text,position:[this.x,this.y],links:this.links}}}]),n}(),p=function(t){return 0===t.length?0:Math.min.apply(Math,m(t))},v=function(t){return 0===t.length?0:Math.max.apply(Math,m(t))};function y(e,t,n){var r=p(t.map(function(t){return t.position[0]}))-n,o=p(t.map(function(t){return t.position[1]}))-n,i=v(t.map(function(t){return t.position[0]+e.view.nodes.get(t).el.clientWidth}))+2*n,a=v(t.map(function(t){return t.position[1]+e.view.nodes.get(t).el.clientHeight}))+2*n;return{left:r,right:i,top:o,bottom:a,width:Math.abs(r-i),height:Math.abs(o-a),getCenter:function(){return[(r+i)/2,(o+a)/2]}}}var g=function(t){function r(t,e){var n;return i(this,r),(n=s(this,a(r).call(this,t,e))).width=0,n.height=0,n.links=[],n.el.className="frame-comment",n}return o(r,d),e(r,[{key:"linkedNodesView",value:function(){var n=this;return this.links.map(function(e){return n.editor.nodes.find(function(t){return t.id===e})}).map(function(t){return n.editor.view.nodes.get(t)})}},{key:"onStart",value:function(){l(a(r.prototype),"onStart",this).call(this),this.linkedNodesView().map(function(t){return t.onStart()})}},{key:"onTranslate",value:function(e,n){l(a(r.prototype),"onTranslate",this).call(this,e,n),this.linkedNodesView().map(function(t){return t.onDrag(e,n)})}},{key:"isContains",value:function(t){var e,n,r=this.el.getBoundingClientRect(),o=this.editor.view.nodes.get(t);return e=r,(n=o.el.getBoundingClientRect()).left>e.left&&n.right<e.right&&n.top>e.top&&n.bottom<e.bottom}},{key:"update",value:function(){l(a(r.prototype),"update",this).call(this),this.el.style.width=this.width+"px",this.el.style.height=this.height+"px"}},{key:"toJSON",value:function(){return n({},l(a(r.prototype),"toJSON",this).call(this),{type:"frame",width:this.width,height:this.height})}}]),r}(),w=function(t){function r(t,e){var n;return i(this,r),(n=s(this,a(r).call(this,t,e))).el.className="inline-comment",n.el.addEventListener("mouseup",n.onDrag.bind(c(c(n)))),n}return o(r,d),e(r,[{key:"onDrag",value:function(){var t=this.getIntersectNode();this.linkTo(t?[t.node.id]:[])}},{key:"getIntersectNode",value:function(){var o=this.el.getBoundingClientRect();return Array.from(this.editor.view.nodes).map(function(t){var e=f(t,2);return{node:e[0],rect:e[1].el.getBoundingClientRect()}}).find(function(t){var e,n,r=t.rect;return e=o,!((n=r).left>e.right||n.right<e.left||n.top>e.bottom||n.bottom<e.top)})}},{key:"offset",value:function(t,e){this.x+=t,this.y+=e,this.update()}},{key:"toJSON",value:function(){return n({},l(a(r.prototype),"toJSON",this).call(this),{type:"inline"})}}]),r}(),b=function(){function n(t){var e=this;i(this,n),this.editor=t,this.comments=[],t.on("zoomed",function(){e.comments.map(function(t){return t.blur.call(t)})})}return e(n,[{key:"addInlineComment",value:function(t,e){var n=this,r=f(e,2),o=r[0],i=r[1],a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],u=new w(t,this.editor);u.k=function(){return n.editor.view.area.transform.k},u.x=o,u.y=i,u.linkTo(a),this.addComment(u)}},{key:"addFrameComment",value:function(t,e){var n=f(e,2),r=n[0],o=n[1],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,u=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,c=new g(t,this.editor);c.x=r,c.y=o,c.width=a,c.height=u,c.linkTo(i),this.addComment(c)}},{key:"addComment",value:function(t){t.update(),this.comments.push(t),this.editor.view.area.appendChild(t.el),this.editor.trigger("commentcreated",t)}},{key:"deleteComment",value:function(t){this.editor.view.area.removeChild(t.el),this.comments.splice(this.comments.indexOf(t),1),this.editor.trigger("commentremoved",t)}},{key:"deleteFocusedComment",value:function(){var t=this.comments.find(function(t){return t.focused()});t&&this.deleteComment(t)}},{key:"deleteComments",value:function(){var e=this;m(this.comments).map(function(t){return e.deleteComment(t)})}},{key:"toJSON",value:function(){return this.comments.map(function(t){return t.toJSON()})}},{key:"fromJSON",value:function(t){var e=this;this.deleteComments(),t.map(function(t){"frame"===t.type?e.addFrameComment(t.text,t.position,t.links,t.width,t.height):e.addInlineComment(t.text,t.position,t.links)})}}]),n}();var k={name:"comment",install:function(f,t){var e=t.margin,h=void 0===e?30:e,n=t.disableBuiltInEdit,r=void 0!==n&&n;f.bind("commentselected"),f.bind("commentcreated"),f.bind("commentremoved"),f.bind("syncframes"),f.bind("addcomment"),f.bind("removecomment"),f.bind("editcomment");var d=new b(f);function o(t){if("KeyF"===t.code&&t.shiftKey){var e=f.selected.list.map(function(t){return t.id}).map(function(e){return f.nodes.find(function(t){return t.id===e})});f.trigger("addcomment",{type:"frame",nodes:e})}else if("KeyC"===t.code&&t.shiftKey){var n=Object.values(f.view.area.mouse);f.trigger("addcomment",{type:"inline",position:n})}else"Delete"===t.code&&d.deleteFocusedComment()}r||f.on("editcomment",function(t){t.text=prompt("Edit comment",t.text),t.update()}),window.addEventListener("keydown",o),f.on("destroy",function(){return window.removeEventListener("keydown",o)}),f.on("addcomment",function(t){var e=t.type,n=t.text,r=t.nodes,o=t.position;if("inline"===e)d.addInlineComment(n,o);else{if("frame"!==e)throw new Error("type '".concat(e,"' not supported"));var i=y(f,r,h),a=i.left,u=i.top,c=i.width,s=i.height,l=r.map(function(t){return t.id});d.addFrameComment(n,o||[a,u],l,c,s)}}),f.on("removecomment",function(t){var e=t.comment,n=t.type;e?d.deleteComment(e):"inline"===n?d.comments.filter(function(t){return t instanceof w}).map(function(t){return d.deleteComment(t)}):"frame"===n&&d.comments.filter(function(t){return t instanceof g}).map(function(t){return d.deleteComment(t)})}),f.on("syncframes",function(){d.comments.filter(function(t){return t instanceof g}).map(function(t){var e=t.links.map(function(e){return f.nodes.find(function(t){return t.id===e})}),n=y(f,e,h),r=n.left,o=n.top,i=n.width,a=n.height;t.x=r,t.y=o,t.width=i,t.height=a,t.update()})}),f.on("nodetranslated",function(t){var e=t.node,n=t.prev,r=e.position[0]-n[0],o=e.position[1]-n[1];d.comments.filter(function(t){return t instanceof w}).filter(function(t){return t.linkedTo(e)}).map(function(t){return t.offset(r,o)})}),f.on("nodedraged",function(r){d.comments.filter(function(t){return t instanceof g}).filter(function(t){var e=t.isContains(r),n=t.links.filter(function(t){return t!==r.id});t.links=e?[].concat(m(n),[r.id]):n})}),f.on("commentselected",function(){var t=m(f.selected.list);f.selected.clear(),t.map(function(t){return t.update?t.update():null})}),f.on("export",function(t){t.comments=d.toJSON()}),f.on("import",function(t){d.fromJSON(t.comments||[])}),f.exist("clear")&&f.on("clear",function(){return d.deleteComments()})}};t.default=k,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=comment-plugin.min.js.map
