{"version":3,"file":"comment-plugin.common.js","sources":["../src/draggable.js","../src/comment.js","../src/utils.js","../src/frame-comment.js","../src/inline-comment.js","../src/manager.js","../src/index.js"],"sourcesContent":["export default class Draggable {\n\n    constructor(el, onStart = () => {}, onTranslate = () => {}, onDrag = () => {}) {\n        this.mouseStart = null;\n\n        this.el = el;\n        this.onStart = onStart;\n        this.onTranslate = onTranslate;\n        this.onDrag = onDrag;\n\n        this.initEvents(el);\n    }\n\n    initEvents(el) {\n        el.addEventListener('pointerdown', this.down.bind(this));\n        window.addEventListener('pointermove', this.move.bind(this));\n        window.addEventListener('pointerup', this.up.bind(this));\n    }\n\n    getCoords(e) {\n        const props = e.touches ? e.touches[0] : e;\n\n        return [props.pageX, props.pageY];\n    }\n\n    down(e) {\n        e.stopPropagation();\n        this.mouseStart = this.getCoords(e);\n\n        this.onStart();\n    }\n\n    move(e) {\n        if (!this.mouseStart) return;\n        e.preventDefault();\n        e.stopPropagation();\n\n        let [x, y] = this.getCoords(e);\n        let delta = [x - this.mouseStart[0], y - this.mouseStart[1]];\n        let zoom = this.el.getBoundingClientRect().width / this.el.offsetWidth;\n\n        this.onTranslate(delta[0] / zoom, delta[1] / zoom);\n    }\n\n    up() {\n        if (this.mouseStart) {\n            this.onDrag();\n        }\n\n        this.mouseStart = null;\n    }\n}","import Draggable from './draggable';\n\nexport default class Comment {\n    constructor(text, editor) {\n        this.editor = editor;\n        this.text = text;\n        this.scale = 1;\n        this.x = 0;\n        this.y = 0;\n        this.dragPosition = [0, 0];\n        this.links = [];\n \n        this.initView();\n        this.update();\n    }\n\n    initView() {\n        this.el = document.createElement('div');\n        this.el.tabIndex = 1;\n        this.el.addEventListener('contextmenu', this.onContextMenu.bind(this));\n        this.el.addEventListener('focus', this.onFocus.bind(this));\n        this.el.addEventListener('blur', this.onBlur.bind(this));\n    \n        new Draggable(this.el, () => this.onStart(), (dx, dy) => this.onTranslate(dx, dy));\n    }\n\n    linkTo(ids) {\n        this.links = ids || [];\n    }\n\n    linkedTo(node) {\n        return this.links.includes(node.id);\n    }\n\n    k() {\n        return 1;\n    }\n\n    onContextMenu(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.editor.trigger('editcomment', this);\n    }\n\n    onFocus() {\n        this.scale = Math.max(1, 1 / this.k());\n        this.update();\n        this.editor.trigger('commentselected', this)\n    }\n\n    focused() {\n        return document.activeElement === this.el;\n    }\n\n    onBlur() {\n        this.scale = 1;\n        this.update()\n    }\n\n    blur() {\n        this.el.blur();\n    }\n\n    onStart() {\n        this.dragPosition = [this.x, this.y];\n    }\n\n    onTranslate (dx, dy) {\n        const [x, y] = this.dragPosition;\n\n        this.x = x + this.scale * dx;\n        this.y = y + this.scale * dy;\n        \n        this.update();\n    }\n\n    update() {\n        this.el.innerText = this.text;\n        this.el.style.transform = `translate(${this.x}px, ${this.y}px) scale(${this.scale})`;\n    }\n\n    toJSON() {\n        return {\n            text: this.text,\n            position: [ this.x, this.y ],\n            links: this.links\n        }\n    }\n}","const min = (arr) => arr.length === 0 ? 0 : Math.min(...arr);\nconst max = (arr) => arr.length === 0 ? 0 : Math.max(...arr);\n\nexport function intersectRect(r1, r2) {\n    return !(\n        r2.left > r1.right || \n        r2.right < r1.left || \n        r2.top > r1.bottom ||\n        r2.bottom < r1.top\n    );\n}\n\nexport function containsRect(r1, r2) {\n    return (\n        r2.left > r1.left && \n        r2.right < r1.right && \n        r2.top > r1.top &&\n        r2.bottom < r1.bottom\n    );\n}\n\nexport function nodesBBox(editor, nodes, margin) {\n    const left = min(nodes.map(node => node.position[0])) - margin;\n    const top = min(nodes.map(node => node.position[1])) - margin;\n    const right = max(nodes.map(node => node.position[0] + editor.view.nodes.get(node).el.clientWidth)) + 2 * margin;\n    const bottom = max(nodes.map(node => node.position[1] + editor.view.nodes.get(node).el.clientHeight)) + 2 * margin;\n    \n    return {\n        left,\n        right,\n        top,\n        bottom,\n        width: Math.abs(left - right),\n        height: Math.abs(top - bottom),\n        getCenter: () => {\n            return [\n                (left + right) / 2,\n                (top + bottom) / 2\n            ];\n        }\n    };\n}","import Comment from './comment';\nimport { containsRect } from './utils';\n\nexport default class FrameComment extends Comment {\n    constructor(text, editor) {\n        super(text, editor);\n        \n        this.width = 0;\n        this.height = 0;\n        this.links = [];\n        this.el.className = 'frame-comment';\n        this.el.title = text;\n    }\n\n    linkedNodesView() {\n        return this.links\n            .map(id => this.editor.nodes.find(n => n.id === id))\n            .map(node => this.editor.view.nodes.get(node));\n    }\n\n    onStart() {\n        super.onStart();\n        this.linkedNodesView().map(nodeView => nodeView.onStart())\n    }\n\n    onTranslate(dx, dy) {\n        super.onTranslate(dx, dy);\n        this.linkedNodesView().map(nodeView => nodeView.onDrag(dx, dy))\n    }\n\n    isContains(node) {\n        const commRect = this.el.getBoundingClientRect();\n        const view = this.editor.view.nodes.get(node);\n    \n        return containsRect(commRect, view.el.getBoundingClientRect());\n    }\n\n    update() {\n        super.update();\n\n        this.el.style.width = this.width+'px';\n        this.el.style.height = this.height+'px';\n    }\n\n    toJSON() {\n        return {\n            ...super.toJSON(),\n            type: 'frame',\n            width: this.width,\n            height: this.height\n        }\n    }\n}","import Comment from './comment';\nimport { intersectRect } from './utils';\n\nexport default class InlineComment extends Comment {\n    constructor(text, editor) {\n        super(text, editor);\n        \n        this.el.className = 'inline-comment';\n        this.el.addEventListener('mouseup', this.onDrag.bind(this));\n    }\n\n    onDrag() {\n        const intersection = this.getIntersectNode();\n\n        this.linkTo(intersection ? [intersection.node.id] : []);\n    }\n\n    getIntersectNode() {\n        const commRect = this.el.getBoundingClientRect();\n\n        return Array.from(this.editor.view.nodes)\n            .map(([node, view]) => {\n                return { node, rect: view.el.getBoundingClientRect() };\n            })\n            .find(({ rect }) => {\n                return intersectRect(commRect, rect);\n            });\n    }\n\n    offset(dx, dy) {\n        this.x += dx;\n        this.y += dy;\n        this.update();\n    } \n\n    toJSON() {\n        return {\n            ...super.toJSON(),\n            type: 'inline'\n        }\n    }\n}","import FrameComment from './frame-comment';\nimport InlineComment from './inline-comment';\n\nexport default class CommentManager {\n    constructor(editor) {\n        this.editor = editor;\n        this.comments = [];\n\n        editor.on('zoomed', () => {\n            this.comments.map(c => c.blur.call(c));\n        });\n    }\n\n    addInlineComment(text, [ x, y ], links = []) {\n        let comment = new InlineComment(text, this.editor);\n\n        comment.k = () => this.editor.view.area.transform.k;\n        comment.x = x;\n        comment.y = y;\n        comment.linkTo(links);\n\n        this.addComment(comment);\n    }\n\n    addFrameComment(text, [ x, y ], links = [], width = 0, height = 0) {\n        let comment = new FrameComment(text, this.editor);\n\n        comment.x = x;\n        comment.y = y;\n        comment.width = width;\n        comment.height = height;\n        comment.linkTo(links);\n        \n        this.addComment(comment);\n    }\n\n    addComment(comment) {\n        comment.update();\n        this.comments.push(comment);\n\n        this.editor.view.area.appendChild(comment.el);\n        this.editor.trigger('commentcreated', comment);\n    }\n\n    deleteComment(comment) {\n        this.editor.view.area.removeChild(comment.el);\n        this.comments.splice(this.comments.indexOf(comment), 1);\n\n        this.editor.trigger('commentremoved', comment);\n    }\n\n    deleteFocusedComment() {\n        const focused = this.comments.find(c => c.focused());\n        \n        if (focused)\n            this.deleteComment(focused)\n    }\n\n    deleteComments() {\n        [...this.comments].map(c => this.deleteComment(c));\n    }\n\n    toJSON() {\n        return this.comments.map(c => c.toJSON())\n    }\n\n    fromJSON(list) {\n        this.deleteComments();\n        list.map(item => {\n            if (item.type === 'frame') {\n                this.addFrameComment(item.text, item.position, item.links, item.width, item.height)\n            } else {\n                this.addInlineComment(item.text, item.position, item.links);\n            }\n        });\n    }\n}","import './style.sass';\nimport CommentManager from './manager';\nimport FrameComment from './frame-comment';\nimport InlineComment from './inline-comment';\nimport { nodesBBox } from './utils';\n\n// eslint-disable-next-line max-statements\nfunction install(editor, { margin = 30, disableBuiltInEdit = false }) {\n    editor.bind('commentselected');\n    editor.bind('commentcreated');\n    editor.bind('commentremoved');\n    editor.bind('syncframes');\n    editor.bind('addcomment');\n    editor.bind('removecomment');\n    editor.bind('editcomment');\n\n    const manager = new CommentManager(editor);\n\n    if (!disableBuiltInEdit) { \n        editor.on('editcomment', (comment) => {\n            comment.text = prompt('Edit comment', comment.text)\n            comment.update();\n        });\n    }\n\n    function handleKey(e) {\n        if (e.code === 'KeyF' && e.shiftKey) {\n            const ids = editor.selected.list.map(node => node.id);\n            const nodes = ids.map(id => editor.nodes.find(n => n.id === id));\n    \n            editor.trigger('addcomment', ({ type: 'frame', nodes }))\n        } else if (e.code === 'KeyC' && e.shiftKey) {\n            const position = Object.values(editor.view.area.mouse);\n\n            editor.trigger('addcomment', ({ type: 'inline', position }))\n        } else if (e.code === 'Delete') {\n            manager.deleteFocusedComment();\n        }\n    }\n\n    window.addEventListener('keydown', handleKey);\n    editor.on('destroy', () => window.removeEventListener('keydown', handleKey));\n\n    editor.on('addcomment', ({ type, text, nodes, position }) => {\n        if (type === 'inline') {\n            manager.addInlineComment(text, position);\n        } else if (type === 'frame') {\n            const { left, top, width, height } = nodesBBox(editor, nodes, margin);\n            const ids = nodes.map(n => n.id);\n        \n            manager.addFrameComment(text, position || [ left, top ], ids, width, height);\n        } else {\n            throw new Error(`type '${type}' not supported`);\n        }\n    })\n\n    editor.on('removecomment', ({ comment, type }) => {\n        if (comment) {\n            manager.deleteComment(comment)\n        } else if (type === 'inline') {\n            manager.comments\n                .filter(c => c instanceof InlineComment)\n                .map(c => manager.deleteComment(c))\n        } else if (type === 'frame') {\n            manager.comments\n                .filter(c => c instanceof FrameComment)\n                .map(c => manager.deleteComment(c))\n        }\n    });\n\n    editor.on('syncframes', () => {\n        manager.comments\n            .filter(comment => comment instanceof FrameComment)\n            .map(comment => {\n                const nodes = comment.links.map(id => editor.nodes.find(n => n.id === id));\n                const { left, top, width, height } = nodesBBox(editor, nodes, margin);\n\n                comment.x = left;\n                comment.y = top;\n                comment.width = width;\n                comment.height = height;\n                \n                comment.update()\n            });\n    })\n\n    editor.on('nodetranslated', ({ node, prev }) => {\n        const dx = node.position[0] - prev[0];\n        const dy = node.position[1] - prev[1];\n\n        manager.comments\n            .filter(comment => comment instanceof InlineComment)\n            .filter(comment => comment.linkedTo(node))\n            .map(comment => comment.offset(dx, dy));\n    });\n\n    editor.on('nodedraged', node => {\n        manager.comments\n            .filter(comment => comment instanceof FrameComment)\n            .filter(comment => {\n                const contains = comment.isContains(node);\n                const links = comment.links.filter(id => id !== node.id);\n\n                comment.links = contains ? [...links, node.id] : links;\n            });\n    });\n\n    editor.on('commentselected', () => {\n        const list = [...editor.selected.list];\n\n        editor.selected.clear();\n        list.map(node => node.update ? node.update() : null);\n    })\n\n    editor.on('export', data => {\n        data.comments = manager.toJSON();\n    });\n\n    editor.on('import', data => {\n        manager.fromJSON(data.comments || []);\n    });\n\n    if (editor.exist('clear')) { // compatibility with previous versions\n        editor.on('clear', () => manager.deleteComments())\n    }\n}\n\nexport default {\n    name: 'comment',\n    install\n}"],"names":["Draggable","el","onStart","onTranslate","onDrag","mouseStart","initEvents","addEventListener","down","bind","window","move","up","e","props","touches","pageX","pageY","stopPropagation","getCoords","preventDefault","x","y","delta","zoom","getBoundingClientRect","width","offsetWidth","Comment","text","editor","scale","dragPosition","links","initView","update","document","createElement","tabIndex","onContextMenu","onFocus","onBlur","dx","dy","ids","node","includes","id","trigger","Math","max","k","activeElement","blur","innerText","style","transform","position","min","arr","length","intersectRect","r1","r2","left","right","top","bottom","containsRect","nodesBBox","nodes","margin","map","view","get","clientWidth","clientHeight","abs","height","getCenter","FrameComment","className","title","find","n","linkedNodesView","nodeView","commRect","type","InlineComment","intersection","getIntersectNode","linkTo","Array","from","rect","CommentManager","comments","on","c","call","comment","area","addComment","push","appendChild","removeChild","splice","indexOf","focused","deleteComment","toJSON","list","deleteComments","item","addFrameComment","addInlineComment","install","disableBuiltInEdit","manager","prompt","handleKey","code","shiftKey","selected","Object","values","mouse","deleteFocusedComment","removeEventListener","Error","filter","prev","linkedTo","offset","contains","isContains","clear","data","fromJSON","exist","name"],"mappings":"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"}